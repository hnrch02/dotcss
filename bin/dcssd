#!/usr/bin/env ruby

if (%w( -h --help -help help ) & ARGV).length > 0
  puts "usage: dcssd [-hv]"
  puts "starts dotcss server in the foreground. kill with <Control>C"
  exit
end

if ARGV.include?('-v')
  puts 'dcssd 1.1'
  exit
end

if Dir.glob('*.css').empty? and not Dir.glob(File.join(ENV['HOME'], ".css/*.css")).empty?
  Dir.chdir(File.join(ENV['HOME'], ".css"))
end

require "webrick"

dotcss = Class.new(WEBrick::HTTPServlet::AbstractServlet) do
  def do_GET(request, response)
    body = build_body(request.path)

    response.status = body.empty? ? 204 : 200
    response['Access-Control-Allow-Origin'] = '*'
    response['Content-Type'] = 'text/css'
    response.body = body
  end

  def build_body(path)
    files = [File.expand_path('default.css')]
    paths = path.gsub('/', '').split('.')

    until paths.empty?
      file = File.expand_path(paths.join('.'))
      files << file if File.file?(file)
      paths.shift
    end

    body = "/* dotcss is working */\n"

    files.each do |file|
      body << File.read(file) + "\n" if File.file?(file)
    end

    body
  end
end

server_options = {
  :BindAddress => "127.0.0.1",
  :Port => 1243,
}

server = WEBrick::HTTPServer.new(server_options)
server.mount('/', dotcss)

%w( INT TERM ).each do |sig|
  trap(sig) { server.shutdown }
end

server.start
